---
import Header from "../components/Header.svelte";
import "../styles/global.css";
import Footer from "../components/Footer.svelte";

// Список команд (можете подтянуть динамически из JSON или захардкодить)
const teams = ["FaZe", "G2", "Vitality", "Natus Vincere"];
---

<head>
  <title>Matches</title>
  <meta charset="UTF-8" />
  <style>
    .bg-gradient {
      background: linear-gradient(180deg, #555555 0%, #111111 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: start;
      align-items: center;
    }
    h1 {
      font-size: 5rem;
      color: #fff;
      font-weight: 400;
    }
    .Team {
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 3rem;
      background-color: transparent;
      border: solid 0.2rem #fff;
      border-radius: 1rem;
      color: #fff;
      padding: 0.5rem;
      margin: 0 1rem;
    }
    .teams {
      display: flex;
      align-items: center;
      justify-content: space-around;
      width: 100%;
      gap: 2rem;
    }
    .TeamBlock {
      flex: 1;
      background-color: rgb(40, 38, 38);
      border-radius: 1rem;
      padding: 1rem;
      color: #ccc;
      max-width: 30vw;
      text-align: center;
      font-size: 5rem;
      font-weight: 600;
    }
    .TeamBlock.Blue {
      border: solid 0.4rem #5f72ff;
      box-shadow: 0 0 20px blue;
    }
    .TeamBlock.Red {
      border: solid 0.4rem #ff5f5f;
      box-shadow: 0 0 20px red;
    }
    #result {
      margin-top: 2rem;
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      color: #fff;
      font-size: 2rem;
      text-align: center;
      min-height: 2.5rem;
      font-size: 5rem;
      font-weight: 600;
      white-space: pre-wrap;
      width: 100%;
    }
    .choise_team {
      display: flex;
      width: 100%;
      align-items: center;
      margin-top: 2rem;
      justify-content: space-evenly;
    }
    span {
      font-size: 9rem;
      font-weight: 700;
      color: #fff;
    }
    #resultTeam1 {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #5f72ff;
      text-decoration: underline;
    }
    #resultTeam2 {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ff5f5f;
      text-align: center;

      text-decoration: underline;
    }
    #resultTeam1,
    #resultTeam2 {
      width: 33%;
      text-align: center;
    }

    #resultTeam3 {
      color: #fff;
      max-width: 35%;
    }
  </style>
</head>

<body>
  <Header client:only />
  <main class="bg-gradient">
    <div class="choise_team">
      <!-- <select id="team1-select" class="Team">
        {teams.map((team) => <option value={team}>{team}</option>)}
      </select> -->
      <h1>Matches</h1>
      <!-- <select id="team2-select" class="Team">
        {teams.map((team) => <option value={team}>{team}</option>)}
      </select> -->
    </div>

    <div class="teams">
      <select id="team1-select" class="Team TeamBlock Blue">
        {teams.map((team) => <option value={team}>{team}</option>)}
      </select>
      <span>VS</span>
      <select id="team2-select" class="Team TeamBlock Red">
        {teams.map((team) => <option value={team}>{team}</option>)}
      </select>
    </div>

    <div id="result">
      <div id="resultTeam1"></div>
      <div id="resultTeam3"></div>
      <div id="resultTeam2"></div>
    </div>
  </main>
  <Footer />

  <script>
    const select1 = document.getElementById("team1-select");
    const select2 = document.getElementById("team2-select");
    const resultDiv = document.getElementById("result");
    const resultTeam1 = document.getElementById("resultTeam1");
    const resultTeam2 = document.getElementById("resultTeam2");
    const resultTeam3 = document.getElementById("resultTeam3");

    async function updatePrediction() {
      const userTeam1 = select1.value;
      const userTeam2 = select2.value;

      // Показываем сразу, какие команды выбраны

      if (userTeam1 === userTeam2) {
        if (userTeam1 === userTeam2) {
          resultTeam1.textContent = "Нельзя выбрать одну и ту же команду.";
          resultTeam2.textContent = "";
          return;
        }
        return;
      }

      // Определяем порядок для API: всегда сначала «лексикографически меньшая»
      let apiTeam1 = userTeam1;
      let apiTeam2 = userTeam2;
      let swapped = false;

      if (userTeam1 > userTeam2) {
        // если значение userTeam1 > userTeam2 лексикографически, меняем
        apiTeam1 = userTeam2;
        apiTeam2 = userTeam1;
        swapped = true;
      }

      resultTeam1.textContent = "Загрузка…";
      resultTeam2.textContent = "";

      try {
        const resp = await fetch("http://localhost:3000/api/predict", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ team1: apiTeam1, team2: apiTeam2 }),
        });

        if (!resp.ok) {
          resultDiv.textContent = "Ошибка при получении прогноза";
          return;
        }

        const { probability, maps_total } = await resp.json();

        // Стандартно probability = P(apiTeam1). Тогда P(apiTeam2) = 1 - probability
        const pA = probability;
        const pB = 1 - probability;

        let displayA, displayB;
        // Если swapped = false, значит apiTeam1 === userTeam1
        if (!swapped) {
          displayA = pA;
          displayB = pB;
        } else {
          // Если swapped = true, значит мы послали (userTeam2, userTeam1) →
          // поэтому P(userTeam2) = pA, а P(userTeam1) = pB.
          displayA = pB; // для userTeam1
          displayB = pA; // для userTeam2
        }

        // Итоговый текст: две вероятности + expected maps

        resultTeam1.textContent = ` ${(displayA * 100).toFixed(1)} %`;
        resultTeam2.textContent = ` ${(displayB * 100).toFixed(1)} %`;
        resultTeam3.textContent = ` Количество карт: ${maps_total.toFixed(2)}`;
      } catch (e) {
        console.error("Ошибка при запросе предсказания:", e);
        resultDiv.textContent = "Не удалось получить прогноз от сервиса";
      }
    }

    select1.addEventListener("change", updatePrediction);
    select2.addEventListener("change", updatePrediction);

    window.addEventListener("DOMContentLoaded", updatePrediction);
  </script>
</body>
